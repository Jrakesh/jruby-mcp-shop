!!!
%html
  %head
    %title Real-time Analytics Dashboard
    %link{href: "https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css", rel: "stylesheet"}
    %link{href: "https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css", rel: "stylesheet"}
    :css
      .card { transition: transform 0.2s; }
      .card:hover { transform: translateY(-5px); }
      .loading-row { background-color: transparent !important; }
  %body
    .container.mt-4
      %h2.mb-4 
        %i.fas.fa-chart-line.me-2
        Real-time Analytics
      
      .row.mb-4
        .col-md-3
          .card.h-100
            .card-body
              %h5.card-title 
                %i.fas.fa-dollar-sign.me-2
                Today's Revenue
              %h3.text-primary#today-revenue
                %i.fas.fa-spinner.fa-spin
        .col-md-3
          .card.h-100
            .card-body
              %h5.card-title
                %i.fas.fa-calendar-alt.me-2 
                Monthly Revenue
              %h3.text-success#monthly-revenue
                %i.fas.fa-spinner.fa-spin
        .col-md-3
          .card.h-100
            .card-body
              %h5.card-title
                %i.fas.fa-shopping-cart.me-2
                Monthly Orders
              %h3.text-info#monthly-orders
                %i.fas.fa-spinner.fa-spin
        .col-md-3
          .card.h-100
            .card-body
              %h5.card-title
                %i.fas.fa-chart-pie.me-2
                Conversion Rate
              %h3.text-warning#conversion-rate
                %i.fas.fa-spinner.fa-spin

      .row
        .col-12
          .card.shadow-sm
            .card-header.bg-light
              %h5.card-title.mb-0
                %i.fas.fa-trophy.me-2
                Top Selling Products
            .card-body
              .table-responsive
                %table.table.table-hover#top-products
                  %thead
                    %tr
                      %th Product
                      %th Units Sold
                      %th Revenue
                  %tbody
                    %tr.loading-row
                      %td{colspan: "3", class: "text-center"}
                        %i.fas.fa-spinner.fa-spin.me-2
                        Loading...

    %script{src: "https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"}
    %script{src: "/js/realtime.js"}

:javascript
  document.addEventListener('DOMContentLoaded', () => {
    const updateRealtime = async () => {
      try {
        const response = await fetch('/api/analytics/realtime');
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const data = await response.json();

        // Format currency
        const formatter = new Intl.NumberFormat('en-US', {
          style: 'currency',
          currency: 'USD'
        });
        
        // Update metrics with data validation
        document.getElementById('today-revenue').innerHTML = 
          data.today_revenue !== undefined ? formatter.format(data.today_revenue) : 'N/A';
        document.getElementById('monthly-revenue').innerHTML = 
          data.monthly_revenue !== undefined ? formatter.format(data.monthly_revenue) : 'N/A';
        document.getElementById('monthly-orders').innerHTML = 
          data.monthly_orders !== undefined ? data.monthly_orders : 'N/A';
        document.getElementById('conversion-rate').innerHTML = 
          data.conversion_rate !== undefined ? `${data.conversion_rate}%` : 'N/A';

        // Update top products table
        const tbody = document.querySelector('#top-products tbody');
        if (data.top_products && data.top_products.length > 0) {
          tbody.innerHTML = data.top_products.map(product => `
            <tr>
              <td>${product.name}</td>
              <td>${product.units_sold}</td>
              <td>${formatter.format(product.revenue)}</td>
            </tr>
          `).join('');
        } else {
          tbody.innerHTML = `
            <tr>
              <td colspan="3" class="text-center">No data available</td>
            </tr>
          `;
        }

        // Remove error states
        document.querySelectorAll('.card').forEach(card => {
          card.classList.remove('border-danger');
          const body = card.querySelector('.card-body');
          if (body) body.classList.remove('text-danger');
        });
      } catch (error) {
        console.error('Error fetching realtime data:', error);
        
        // Show error state in metrics
        ['today-revenue', 'monthly-revenue', 'monthly-orders', 'conversion-rate'].forEach(id => {
          const element = document.getElementById(id);
          if (element) element.innerHTML = '<span class="text-danger">Error</span>';
        });

        // Show error in table
        const tbody = document.querySelector('#top-products tbody');
        if (tbody) {
          tbody.innerHTML = `
            <tr>
              <td colspan="3" class="text-center text-danger">
                <i class="fas fa-exclamation-circle me-2"></i>
                Error loading data
              </td>
            </tr>
          `;
        }

        // Add error styling to cards
        document.querySelectorAll('.card').forEach(card => {
          card.classList.add('border-danger');
          const body = card.querySelector('.card-body');
          if (body) body.classList.add('text-danger');
        });
      }
    };

    // Initial update
    updateRealtime();
    
    // Update every 5 seconds
    const interval = setInterval(updateRealtime, 5000);

    // Clean up interval on page unload
    window.addEventListener('unload', () => clearInterval(interval));
  });
